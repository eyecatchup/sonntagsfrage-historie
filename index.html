<!doctype html>
<head>
    <title>Verlauf Projektionen Sonntagsfrage Bundestagswahl (alle Institute)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: scroll; }
        .menu { position: relative; width: 100%; display: flex; }
        .menu > div { padding: 15px; }
        #chart { position: relative; width: 100%; height: 100vh; }
        label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="menu">
        <div>
            <label for="institut">Institut</label>
            <select id="institut" onchange="updateChart()">
                <option value="alle">Alle</option>
                <option value="Forsa">Forsa</option>
                <option value="INSA">INSA</option>
                <option value="dimap">dimap</option>
                <option value="Emnid">Emnid</option>
                <option value="Forschungsg. Wahlen">Forschungsgruppe Wahlen</option>
                <option value="Allensbach">Allensbach</option>
                <option value="YouGov">YouGov</option>
                <option value="GMS">GMS</option>
            </select>
        </div>
        <div>
            <label>
                Von:
                <input type="date" name="start" id="start" onchange="updateChart()"/>
            </label>
        </div>
        <div>
            <label>
                Bis:
                <input type="date" name="end" id="end" onchange="updateChart()"/>
            </label>
        </div>
        <div>
            <a id="download" download="chart.jpg" href="#" title="Aktuelles Chart speichern">
                Grafik speichern
            </a>
        </div>
    </div>
    <canvas id="chart"></canvas>
    <script>
        const inputEnddate = document.getElementById('end')
        const inputStartdate = document.getElementById('start')
        const inputInstitut = document.getElementById('institut')
        const params = new URLSearchParams(location.search)

        let allJson

        function updateURL() {
            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value

            if (inputStartdate.value === '' && params.has('start')) {
                params.delete('start')
            } 
            if (inputStartdate.value !== '') {
                params.set('start', inputStartdate.value)
            }

            if (inputEnddate.value === '' && params.has('end')) {
                params.delete('end')
            } 
            if (inputEnddate.value !== '') {
                params.set('end', inputEnddate.value)
            }

            if (institut === 'alle' && params.has('institut')) {
                params.delete('institut')
            }
            if (institut !== 'alle') {
                params.set('institut', institut)
            }

            history.replaceState(null, null, '?' + params.toString())
        }

        function updateChart() {
            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value
            renderChart(prepareData(
                allJson, 
                institut === 'alle' ? [] : [institut], 
                inputStartdate.value, 
                inputEnddate.value
            ))
            updateURL()
        }

        const prepareData = (json, filterInstituts = [], start = '', end = '') => {
            const tension = 0
            const data = {
                labels: [],
                datasets: [
                    { label: "CDU/CSU", data: [], borderColor: 'black', backgroundColor: 'black', tension: tension },
                    { label: "SPD", data: [], borderColor: '#E30613', backgroundColor: '#E30613', tension: tension },
                    { label: "Gr√ºne", data: [], borderColor: '#409A3C', backgroundColor: '#409A3C', tension: tension },
                    { label: "FDP", data: [], borderColor: '#FFED00', backgroundColor: '#FFED00', tension: tension },
                    { label: "Linke", data: [], borderColor: '#BE3075', backgroundColor: '#BE3075', tension: tension },
                    { label: "AfD", data: [], borderColor: '#009EE0', backgroundColor: '#009EE0', tension: tension },
                    { label: "FW", data: [], borderColor: '#F7A800', backgroundColor: '#F7A800', tension: tension },
                    { label: "BSW", data: [], borderColor: '#7D254F', backgroundColor: '#7D254F', tension: tension },
                    { label: "Sonstige", data: [], borderColor: 'rgba(0, 0, 0, 0.1)', backgroundColor: 'rgba(0, 0, 0, 0.1)', tension: tension }      
                ]
            }

            for (let i = 0; i < json.length; i++) {
                // 1. if date is already set, skip
                let conditionsPass = !data.labels.includes(json[i].vDatum)
                if (!conditionsPass) {
                    continue
                }

                // 2. if daterange filter is set, skip if not in daterange
                const date = new Date(json[i].vDatum)
                if (start !== '') {
                    conditionsPass = new Date(start) < date
                }
                if (!conditionsPass) {
                    continue
                }
                if (end !== '') {
                    conditionsPass = date < new Date(end)
                }
                if (!conditionsPass) {
                    continue
                }

                // 3. if institut filter is set, skip if institut is not selected
                if (filterInstituts.length) {
                    conditionsPass = filterInstituts.includes(json[i].institut)
                }
                if (!conditionsPass) {
                    continue
                }

                data.labels.push(json[i].vDatum.split('T')[0])
                data.datasets[0].data.push(json[i].cducsu)
                data.datasets[1].data.push(json[i].spd)
                data.datasets[2].data.push(json[i].grne)
                data.datasets[3].data.push(json[i].fdp)
                data.datasets[4].data.push(json[i].linke)
                data.datasets[5].data.push(json[i].afd)
                data.datasets[6].data.push(json[i].fw)
                data.datasets[7].data.push(json[i].bsw)
                data.datasets[8].data.push(json[i].sonstige)
            }

            return data
        }

        const renderChart = (data) => {
            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value
            let chartTitle = `Verlauf Projektionen Sonntagsfrage Bundestagswahl (${institut === 'alle' ? 'Alle Institute' : institut}`
            if (inputStartdate.value === '' && inputEnddate.value === '') {
                chartTitle += ')'
            } else {
                if (inputStartdate.value !== '' && inputEnddate.value === '') {
                    const dt = new Date(inputStartdate.value)
                    chartTitle += `, seit ${dt.toLocaleDateString()})`
                } else if (inputStartdate.value === '' && inputEnddate.value !== '') {
                    const dt = new Date(inputEnddate.value)
                    chartTitle += `, bis ${dt.toLocaleDateString()})`
                } else if (inputStartdate.value !== '' && inputEnddate.value !== '') {
                    const dtStart = new Date(inputStartdate.value)
                    const dtEnd = new Date(inputEnddate.value)
                    chartTitle += `, zwischen ${dtStart.toLocaleDateString()} und ${dtEnd.toLocaleDateString()})`
                }
            }

            document.getElementById('chart').remove()
            let canvas = document.createElement('canvas')
            canvas.id = 'chart'
            document.body.appendChild(canvas)

            const bgPlugin = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart, args, options) => {
                    const {ctx} = chart;
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = options.color || '#99ffff';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            }

            new Chart(document.getElementById('chart'), {
                type: 'line',
                data: data,
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle
                        },
                        customCanvasBackgroundColor: {
                            color: '#fff'
                        }
                    }
                },
                plugins: [bgPlugin]
            })
        }

        (async () => {
            fetch('./data.json')
            .then((response) => response.json())
            .then((json) => {
                allJson = json

                const end = params.has('end') ? params.get('end') : ''
                const start = params.has('start') ? params.get('start') : ''
                const institut = params.has('institut') ? [params.get('institut')] : []

                if (end !== '') {
                    inputEnddate.value = end
                }
                if (start !== '') {
                    inputStartdate.value = start
                }
                if (institut.length) {
                    inputInstitut.value = params.get('institut')
                }

                renderChart(prepareData(json, institut, start, end))
            })

            document.getElementById('download').addEventListener('click', function() {
                document.getElementById('download').href = document.getElementById('chart').toDataURL('image/jpg')
            })
        })()
    </script>
</body>
