<!doctype html>
<html lang="de">
<head>
    <title>Verlauf Projektionen Sonntagsfrage Bundestagswahl (alle Institute)</title>
    <meta name="description" content="Interaktive Verlaufsdiagramme (seit 2013) von Projektionen zur Sonntagsfrage Bundestagswahl aller Umfrageinstitute">
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0 "></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; }
        .menu { position: relative; width: 100%; display: flex; }
        .menu > div, .footer-note { padding: 15px; }
        #chart { position: relative; width: 100%; height: 100vh; }
        label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="menu">
        <div>
            <label for="institut">Institut</label>
            <select id="institut" onchange="updateChart()">
                <option value="alle">Alle</option>
                <option value="Forsa">Forsa</option>
                <option value="INSA">INSA</option>
                <option value="dimap">dimap</option>
                <option value="Emnid">Emnid</option>
                <option value="Forschungsg. Wahlen">Forschungsgruppe Wahlen</option>
                <option value="Allensbach">Allensbach</option>
                <option value="YouGov">YouGov</option>
                <option value="GMS">GMS</option>
            </select>
        </div>
        <div>
            <label>
                Von:
                <input type="date" name="start" id="start" onchange="updateChart()"/>
            </label>
        </div>
        <div>
            <label>
                Bis:
                <input type="date" name="end" id="end" onchange="updateChart()"/>
            </label>
        </div>
        <div>
            <input type="checkbox" id="datalabels" name="datalabels" onchange="updateChart()">
            <label for="datalabels"> Labels anzeigen</label>
        </div>
        <div>
            <a id="download" download="chart.jpg" href="#" title="Aktuelles Chart speichern">
                Chart als Grafik speichern
            </a>
        </div>
    </div>
    <div id="chart-wrapper"><canvas id="chart"></canvas></div>
    <div class="footer-note">(c) <a href="https://github.com/eyecatchup/sonntagsfrage-historie/" target="_blank" rel="nofollow">Open Source</a> by Stephan Schmitz, Datenquelle: <a href="https://www.wahlrecht.de/umfragen/" target="_blank" ref="nofollow">wahlrecht.de</a></div>
    <script>
        const inputEnddate = document.getElementById('end')
        const inputStartdate = document.getElementById('start')
        const inputInstitut = document.getElementById('institut')
        const inputLabels = document.getElementById('datalabels')
        const params = new URLSearchParams(location.search)

        let jsonData

        function updateURL() {
            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value;
            (inputStartdate.value === '' && params.has('start')) && params.delete('start');
            inputStartdate.value !== '' && params.set('start', inputStartdate.value);
            (inputEnddate.value === '' && params.has('end')) && params.delete('end');
            inputEnddate.value !== '' && params.set('end', inputEnddate.value);
            (institut === 'alle' && params.has('institut')) && params.delete('institut');
            institut !== 'alle' && params.set('institut', institut);

            history.replaceState(null, null, '?' + params.toString())
        }

        function updateChart() {  
            renderChart()
            updateURL()
        }

        const prepareData = () => {
            const tension = 0
            const data = {
                labels: [],
                datasets: [
                    { label: 'CDU/CSU', data: [], borderColor: 'black', backgroundColor: 'black', tension: tension, datalabels: { color: '#000' } },
                    { label: 'SPD', data: [], borderColor: '#E30613', backgroundColor: '#E30613', tension: tension, datalabels: { color: '#E30613' } },
                    { label: 'Gr√ºne', data: [], borderColor: '#409A3C', backgroundColor: '#409A3C', tension: tension, datalabels: { color: '#409A3C' } },
                    { label: 'FDP', data: [], borderColor: '#FFED00', backgroundColor: '#FFED00', tension: tension, datalabels: { color: '#FFED00' } },
                    { label: 'Linke', data: [], borderColor: '#BE3075', backgroundColor: '#BE3075', tension: tension, datalabels: { color: '#BE3075' } },
                    { label: 'AfD', data: [], borderColor: '#009EE0', backgroundColor: '#009EE0', tension: tension, datalabels: { color: '#009EE0' } },
                    { label: 'FW', data: [], borderColor: '#F7A800', backgroundColor: '#F7A800', tension: tension, datalabels: { color: '#F7A800' } },
                    { label: 'BSW', data: [], borderColor: '#7D254F', backgroundColor: '#7D254F', tension: tension, datalabels: { color: '#7D254F' }},
                    { label: 'Sonstige', data: [], borderColor: 'rgba(0, 0, 0, 0.1)', backgroundColor: 'rgba(0, 0, 0, 0.1)', tension: tension, datalabels: { color: 'rgba(0, 0, 0, 0.3)' } }      
                ]
            }

            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value
            for (let i = 0; i < jsonData.length; i++) {
                const date = new Date(jsonData[i].vDatum)
                const localeDateString = date.toLocaleDateString()

                // if date is already set, skip
                // or, if daterange filter is set, skip if not in daterange
                // or, if institut filter is set, skip if institut is not selected
                if (
                    data.labels.includes(localeDateString) ||
                    (inputStartdate.value !== '' && new Date(inputStartdate.value) > date) ||
                    (inputEnddate.value !== '' && date > new Date(inputEnddate.value)) ||
                    (institut !== 'alle' && institut !== jsonData[i].institut)
                ) {
                    continue
                }

                data.labels.push(localeDateString)
                data.datasets[0].data.push(jsonData[i].cducsu)
                data.datasets[1].data.push(jsonData[i].spd)
                data.datasets[2].data.push(jsonData[i].grne)
                data.datasets[3].data.push(jsonData[i].fdp)
                data.datasets[4].data.push(jsonData[i].linke)
                data.datasets[5].data.push(jsonData[i].afd)
                data.datasets[6].data.push(jsonData[i].fw)
                data.datasets[7].data.push(jsonData[i].bsw)
                data.datasets[8].data.push(jsonData[i].sonstige)
            }

            return data
        }

        const renderChart = () => {
            const institut = inputInstitut.options[inputInstitut.options.selectedIndex].value
            let chartTitle = `Verlauf Projektionen Sonntagsfrage Bundestagswahl (${institut === 'alle' ? 'Alle Institute' : institut}`
            if (inputStartdate.value === '' && inputEnddate.value === '') {
                chartTitle += ')'
            } else {
                if (inputStartdate.value !== '' && inputEnddate.value === '') {
                    const dt = new Date(inputStartdate.value)
                    chartTitle += `, seit ${dt.toLocaleDateString()})`
                } else if (inputStartdate.value === '' && inputEnddate.value !== '') {
                    const dt = new Date(inputEnddate.value)
                    chartTitle += `, bis ${dt.toLocaleDateString()})`
                } else if (inputStartdate.value !== '' && inputEnddate.value !== '') {
                    const dtStart = new Date(inputStartdate.value)
                    const dtEnd = new Date(inputEnddate.value)
                    chartTitle += `, zwischen ${dtStart.toLocaleDateString()} und ${dtEnd.toLocaleDateString()})`
                }
            }

            document.getElementById('chart').remove()
            let canvas = document.createElement('canvas')
            canvas.id = 'chart'
            document.getElementById('chart-wrapper').appendChild(canvas)

            const plugins = [
                {
                    id: 'customCanvasBackgroundColor',
                    beforeDraw: (chart, args, options) => {
                        const {ctx} = chart
                        ctx.save()
                        ctx.globalCompositeOperation = 'destination-over'
                        ctx.fillStyle = options.color || '#99ffff'
                        ctx.fillRect(0, 0, chart.width, chart.height)
                        ctx.restore()
                    }
                }
            ]
            if (inputLabels.checked) {
                plugins.push(ChartDataLabels)
            }

            new Chart(document.getElementById('chart'), {
                type: 'line',
                data: prepareData(),
                options: {
                    plugins: {
                        datalabels: { align: 'top' },
                        title: { display: true, text: chartTitle },
                        customCanvasBackgroundColor: { color: '#fff' }
                    }
                },
                plugins: plugins
            })
        }

        (() => {
            params.has('end') && (inputEnddate.value = params.get('end'))
            params.has('start') && (inputStartdate.value = params.get('start'))
            params.has('institut') && (inputInstitut.value = params.get('institut'))

            fetch('./data.json')
            .then((response) => response.json())
            .then((json) => {
                jsonData = json
                renderChart()
            })

            const dlLink = document.getElementById('download')
            dlLink.addEventListener('click', () => {
                dlLink.download = `chart-projektionen-btw-${Date.now()}.jpg`
                dlLink.href = document.getElementById('chart').toDataURL('image/jpg')
            })
        })()
    </script>
</body>
</html>
